<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Python Chat App Yo</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" 
    integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <style>
      div.msg_bbl {
        background-color: #ddd;
        padding: 5px 10px;
        border-radius: 10px;
        color: #555;
        margin-bottom: 5px;
      }
      div.message_holder{
        width: 100%;
        height: 600px;
        overflow-x: hidden;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>

    <div class="text-center well"><b>My Super Python Chat App</b></div>

    <div class="container">
      <div class="col-sm-8">
        <div class="no_message">
          <div class="btn_grup"></div>
          <h1 style='color: #ccc'>No message yet..</h1>
          <div id="message_holder" class="message_holder"></div>
        </div>
      </div>
      <div class="col-sm-4">
        <div class="no_message">
          <h1 style='color: #ccc'>No message yet..</h1>
          <div class="message_holder2"></div>
        </div>
        <!-- <form action="" method="POST">
          <b>Type your message below <span class="glyphicon glyphicon-arrow-down"></span></b>
          <div class="clearfix" style="margin-top: 5px;"></div>
          <input type="text" class="username form-control" placeholder="User Name">
          <div style="padding-top: 5px;"></div>
          <input type="text" class="message form-control" placeholder="Messages">
          <div style="padding-top: 5px;"></div>
          <button type="submit" class="btn btn-success btn-block"><span class="glyphicon glyphicon-send"></span> Send</button>
        </form> -->
      </div>
    </div>


    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.min.js"></script>
    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>

    <!-- TODO: Add SDKs for Firebase products that you want to use
        https://firebase.google.com/docs/web/setup#available-libraries -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-analytics.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
	<script>
    var firebaseConfig = {
            apiKey: "AIzaSyBO9fmyGtUOGCnG_4CcXXwCMGlUGSIRi38",
            authDomain: "finalproject-af65a.firebaseapp.com",
            databaseURL: "https://finalproject-af65a-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "finalproject-af65a",
            storageBucket: "finalproject-af65a.appspot.com",
            messagingSenderId: "120718877342",
            appId: "1:120718877342:web:d6e808dbcf42ec5035518f",
            measurementId: "G-VWZDM26D4Z"
        };
    firebase.initializeApp(firebaseConfig);
    firebase.analytics();
    $( 'h1' ).remove()
    var grup = firebase.database().ref('grup/')
    var percakapan = []
    var perindex = 0
    var select_grup = 'percobaan_ta'
    grup.once('value',snapshot=>{
      snapshot.forEach(child => {
        console.log(child.key);
        var a = '<button class="btn btn-success btn-block" onclick="ganti(\''+child.key+'\')">'+child.key+'</button>'
        $( 'div.btn_grup' ).append(a)
      })
    })
    // $("button").click(function() {
    //   var fired_button = $(this).val();
    //   alert(fired_button);
    //   console.log(123)
    // });




    var reff = firebase.database().ref('grup/')
    function ganti(a){
      var reff = firebase.database().ref('grup/'+a)
      $( 'div.msg_bbl' ).remove()
      select_grup = a
      tampil(reff)
      console.log('jalan')
    }

    // function ambil_ratings(){
    //   return new Promise(resolve => {
    //     var ambil = firebase.database().ref('Rating/')
    //     var Rate = ['No Record','No Record','No Record']
    //     var rating = {}
    //     ambil.once('value', (snapshot)=>{
    //       snapshot.forEach((data)=>{
    //         rating[data.key] = {
    //         'Hit' : data.val()['Hit'],
    //         'Miss' : data.val()['Miss'],
    //         'Rate' : data.val()['Rate']
    //         }
    //       })
    //       // console.log('RATES', rating)
    //       resolve(rating)
    //     })
    //   })
    // }
    // var c = 'asdasd'
    // function asd(sda){
    //   c = sda
    //   console.log('asdasdasdasd',c)
    // }

    // // var rating = ambil_ratings()
    // // rating.then((data) => {var aaa = data})
    // // console.log(aaa)
    // var a = 'asdasd'
    // async function cobaAsync(){
    //   const coba = await ambil_ratings();
    //   a = coba
    //   console.log(a)
    //   asd(a)
    // }

    // var rateeee = cobaAsync()
    // console.log('AVCDSA',c)

    function tampil(reff){
      reff.once('value', (snapshot)=>{
        percakapan = []
        snapshot.forEach((data) => {
          // var Rate = ambil_rating(data.val()['user'])
          var Rate = ['No Record','No Record','No Record']
          console.log('Raate', Rate)
          var ada = false
          var a = '<div class="msg_bbl msg_bbl3"><b style="color: #000">'+'User : '+'</b>'+data.val()['user']+'<br>'
          if(data.val()['balas_pesan'] != '-'){
            a = a + '<b style="color: #000">'+'Membalas : '+'</b>'+data.val()['balas_pesan']+'<br>'
          }
          a = a +'<b style="color: #000">'+'Pesan : '+'</b>'+data.val()['pesan']+'<br>'
            +'<b style="color: #000">'+'Label : '+'</b>'+data.val()['prediksi']+'Rating : '+'</b>'+'<br>'
            +'Hit : '+Rate[0]+'<br>'+' Miss : '+Rate[1]+'<br>'+'Rate : '+Rate[2]+'</div>'
            $( 'div.message_holder' ).append(a)

            if(percakapan.length==0){
              percakapan.push([data.val()['message_id']])
              perindex = 1
              ada = true
            } else if (data.val()['balas_message_id'] != '-'){
              percakapan.forEach((a, ind)=>{
                perindex2 = ind
                a.forEach((b, ind2)=>{
                  if(data.val()['balas_message_id'] == b){
                    percakapan[perindex2] = percakapan[perindex2].concat(data.val()['message_id'])
                    perindex = perindex2 + 1
                    ada = true
                  }
                })
              })
            }
            if(!ada){
              console.log('masuk ada')
              percakapan.push([data.val()['message_id']])
              perindex = percakapan.length
            }
            // else if (data.val()['balas_message_id'])

            dataa = !!document.getElementById("percakapan".concat(perindex))
            console.log(dataa)
            if(dataa){
              console.log("Jalan1")
              cakap = document.getElementById("percakapan".concat(perindex))
              $(cakap).append(
                '<div id="msg_bbl2"><b style="color: #000">'+'User : '+'</b>'+data.val()['user']+'<br>'
                +'<b style="color: #000">'+'Pesan : '+'</b>'+data.val()['pesan']+'<br></div>'
              )
              cakap.style.display = "block";
            } else {
              console.log("Jalan2")
              $( 'div.message_holder2' ).append( '<div id='+'percakapan'.concat(perindex)+' class="msg_bbl"> <b style="color: #000"> PERCAKAPAN '.concat(perindex)+'</b>'+'<div class="msg_bbl2"><b style="color: #000">'+'User : '+'</b>'+data.val()['user']+'<br>'
                +'<b style="color: #000">'+'Pesan : '+'</b>'+data.val()['pesan']+'<br></div>'+'</div>')
                document.getElementById("percakapan".concat(perindex)).style.display = "none";
            }
            var pjg = document.getElementsByClassName("msg_bbl3").length - 1
            console.log('panjang ',pjg)
            document.getElementsByClassName("msg_bbl3")[pjg].scrollIntoView();
        })
      })
    }

    // function ambil_rating(user){
    //   var ambil = firebase.database().ref('Rating/')
    //   var Rate = ['No Record','No Record','No Record']
    //   ambil.once('value', (snapshot)=>{
    //     snapshot.forEach((data)=>{
    //       if (data.key == user){
    //         Rate[0] = data.val()['Hit']
    //         Rate[1] = data.val()['Miss']
    //         Rate[2] = data.val()['Rate']
    //       }
    //     })
    //     console.log('RATES', Rate)
    //     return Rate
    //   })
    // }

    reff.on('child_added', (data)=>{
      // var Rate = ambil_rating(data.val()['user'])
      var Rate = ['No Record','No Record','No Record']
      console.log(data.val())
      console.log(select_grup)
      console.log(percakapan)
      console.log("masukkkk")
        if (select_grup == data.val()['grup']){
          var ada = false
          var a = '<div class="msg_bbl msg_bbl3"><b style="color: #000">'+'User : '+'</b>'+data.val()['user']+'<br>'
          if(data.val()['balas_pesan'] != '-'){
            a = a + '<b style="color: #000">'+'Membalas : '+'</b>'+data.val()['balas_pesan']+'<br>'
          }
          a = a +'<b style="color: #000">'+'Pesan : '+'</b>'+data.val()['pesan']+'<br>'
            +'<b style="color: #000">'+'Label : '+'</b>'+data.val()['prediksi']+'Rating : '+'</b>'+'<br>'
        +'Hit : '+Rate[0]+'<br>'+' Miss : '+Rate[1]+'<br>'+'Rate : '+Rate[2]+'</div>'
            $( 'div.message_holder' ).append(a)

            if(percakapan.length==0){
              percakapan.push([data.val()['message_id']])
              perindex = 1
              ada = true
            } else if (data.val()['balas_message_id'] != '-'){
              percakapan.forEach((a, ind)=>{
                perindex2 = ind
                a.forEach((b, ind2)=>{
                  if(data.val()['balas_message_id'] == b){
                    percakapan[perindex2] = percakapan[perindex2].concat(data.val()['message_id'])
                    perindex = perindex2 + 1
                    ada = true
                  }
                })
              })
            }
            if(!ada){
              console.log('masuk ada')
              percakapan.push([data.val()['message_id']])
              perindex = percakapan.length
            }
            // else if (data.val()['balas_message_id'])

            dataa = !!document.getElementById("percakapan".concat(perindex))
            console.log(dataa)
            if(dataa){
              console.log("Jalan1")
              cakap = document.getElementById("percakapan".concat(perindex))
              $(cakap).append(
                '<div id="msg_bbl2"><b style="color: #000">'+'User : '+'</b>'+data.val()['user']+'<br>'
                +'<b style="color: #000">'+'Pesan : '+'</b>'+data.val()['pesan']+'<br></div>'
              )
              cakap.style.display = "block";
            } else {
              console.log("Jalan2")
              $( 'div.message_holder2' ).append( '<div id='+'percakapan'.concat(perindex)+' class="msg_bbl"> <b style="color: #000"> PERCAKAPAN '.concat(perindex)+'</b>'+'<div class="msg_bbl2"><b style="color: #000">'+'User : '+'</b>'+data.val()['user']+'<br>'
                +'<b style="color: #000">'+'Pesan : '+'</b>'+data.val()['pesan']+'<br></div>'+'</div>')
                document.getElementById("percakapan".concat(perindex)).style.display = "none";
            }
            var pjg = document.getElementsByClassName("msg_bbl3").length - 1
            console.log('panjang ',pjg)
            document.getElementsByClassName("msg_bbl3")[pjg].scrollIntoView();
          }
    })
    // function tampil(reff){
    //   reff.on('child_added', (data)=>{
    //     console.log(percakapan)
    //     var ada = false
    //     var a = '<div class="msg_bbl msg_bbl3"><b style="color: #000">'+'User : '+'</b>'+data.val()['user']+'<br>'
    //     if(data.val()['balas_pesan'] != '-'){
    //       a = a + '<b style="color: #000">'+'Membalas : '+'</b>'+data.val()['balas_pesan']+'<br>'
    //     }
    //     a = a +'<b style="color: #000">'+'Pesan : '+'</b>'+data.val()['pesan']+'<br>'
    //       +'<b style="color: #000">'+'Label : '+'</b>'+data.val()['prediksi']+'</div>'
    //       $( 'div.message_holder' ).append(a)

    //       if(percakapan.length==0){
    //         percakapan.push([data.val()['message_id']])
    //         perindex = 1
    //         ada = true
    //       } else if (data.val()['balas_message_id'] != '-'){
    //         percakapan.forEach((a, ind)=>{
    //           perindex2 = ind
    //           a.forEach((b, ind2)=>{
    //             if(data.val()['balas_message_id'] == b){
    //               percakapan[perindex2] = percakapan[perindex2].concat(data.val()['message_id'])
    //               perindex = perindex2 + 1
    //               ada = true
    //             }
    //           })
    //         })
    //       }
    //       if(!ada){
    //         console.log('masuk ada')
    //         percakapan.push([data.val()['message_id']])
    //         perindex = percakapan.length
    //       }
    //       // else if (data.val()['balas_message_id'])



    //       dataa = !!document.getElementById("percakapan".concat(perindex))
    //       console.log(dataa)
    //       if(dataa){
    //         console.log("Jalan1")
    //         cakap = document.getElementById("percakapan".concat(perindex))
    //         $(cakap).append(
    //           '<div id="msg_bbl2"><b style="color: #000">'+'User : '+'</b>'+data.val()['user']+'<br>'
    //           +'<b style="color: #000">'+'Pesan : '+'</b>'+data.val()['pesan']+'<br></div>'
    //         )
    //         cakap.style.display = "block";
    //       } else {
    //         console.log("Jalan2")
    //         $( 'div.message_holder2' ).append( '<div id='+'percakapan'.concat(perindex)+' class="msg_bbl"> <b style="color: #000"> PERCAKAPAN '.concat(perindex)+'</b>'+'<div class="msg_bbl2"><b style="color: #000">'+'User : '+'</b>'+data.val()['user']+'<br>'
    //           +'<b style="color: #000">'+'Pesan : '+'</b>'+data.val()['pesan']+'<br></div>'+'</div>')
    //           document.getElementById("percakapan".concat(perindex)).style.display = "none";
    //       }
    //       var pjg = document.getElementsByClassName("msg_bbl3").length - 1
    //       console.log('panjang ',pjg)
    //       document.getElementsByClassName("msg_bbl3")[pjg].scrollIntoView();
    // })
    // }
	</script>
  </body>
</html>